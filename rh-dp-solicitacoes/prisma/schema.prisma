generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   ENUMS
   ========================= */

enum Role {
  COLABORADOR
  RH
  DP
  ADMIN
}

enum Setor {
  RH
  DP
}

enum Status {
  ABERTA
  EM_ANALISE
  AGUARDANDO_INFO
  APROVADA
  REJEITADA
  CONCLUIDA
}

enum UserStatus {
  ATIVO
  INATIVO
}

enum CCStatus {
  ACTIVE
  INACTIVE
}

/* ===== NOVOS ENUMS ===== */

enum Action {
  VIEW
  CREATE
  UPDATE
  DELETE
  APPROVE
}

enum GroupRole {
  MEMBER
  MANAGER
}

/* =========================
   MODELOS DE SUPORTE
   ========================= */

model Attachment {
  id             String       @id
  solicitationId String
  filename       String
  url            String
  mimeType       String
  sizeBytes      Int
  createdAt      DateTime     @default(now())

  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model Comment {
  id             String       @id
  solicitationId String
  autorId        String
  texto          String
  createdAt      DateTime     @default(now())

  autor          User         @relation("CommentAutor", fields: [autorId], references: [id])
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model Event {
  id             String       @id
  solicitationId String
  actorId        String
  tipo           String
  createdAt      DateTime     @default(now())

  actor          User         @relation("EventActor", fields: [actorId], references: [id])
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

/* =========================
   CATALOGOS / CADASTROS
   ========================= */

model CostCenter {
  id             String    @id @default(uuid())
  code           String?
  externalCode   String?
  abbreviation   String?
  area           String?
  managementType String?
  groupName      String?   @map("group_name")
  status         CCStatus  @default(ACTIVE)
  description    String
  observations   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  users          User[]

  @@map("CostCenter")
}

model Position {
  id          String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  name        String   @unique
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("Position")
}

model Leader {
  id        String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  fullName  String
  email     String? @unique
  phone     String?
  members   User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Leader")
}

/* =========================
   NÚCLEO DE SOLICITAÇÕES
   ========================= */

model TipoSolicitacao {
  id           String   @id
  nome         String   @unique
  descricao    String?
  schemaJson   Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  solicitacoes Solicitation[]
}

model Solicitation {
  id            String   @id
  titulo        String
  descricao     String
  setorDestino  Setor
  status        Status   @default(ABERTA)
  autorId       String
  responsavelId String?
  tipoId        String
  payload       Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  anexos        Attachment[]
  comentarios   Comment[]
  eventos       Event[]

  autor         User            @relation("SolicitationAutor", fields: [autorId], references: [id])
  responsavel   User?           @relation("SolicitationResponsavel", fields: [responsavelId], references: [id])
  tipo          TipoSolicitacao @relation(fields: [tipoId], references: [id])
}

/* =========================
   USUÁRIO
   ========================= */

model User {
  id            String     @id @default(dbgenerated("(gen_random_uuid())::text"))
  email         String     @unique
  fullName      String
  login         String?    @unique(map: "user_login_key")
  phone         String?

  costCenterId  String?
  costCenter    CostCenter? @relation(fields: [costCenterId], references: [id])

  positionId    String?
  position      Position?   @relation(fields: [positionId], references: [id])

  leaderId      String?
  leader        Leader?     @relation(fields: [leaderId], references: [id])

  status        UserStatus  @default(ATIVO)
  role          Role        @default(COLABORADOR)
  authId        String?     @db.Uuid
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  solicitacoesCriadas   Solicitation[] @relation("SolicitationAutor")
  solicitacoesAssumidas Solicitation[] @relation("SolicitationResponsavel")
  comments              Comment[]      @relation("CommentAutor")
  events                Event[]        @relation("EventActor")

  membersOfGroups       GroupMember[]

  @@map("User")
}

/* =========================
   CONTROLE DE ACESSOS
   ========================= */

model Module {
  id     String @id @default(uuid())
  key    String @unique
  name   String
  grants AccessGroupGrant[]

  @@map("Module")
}

model AccessGroup {
  id        String   @id @default(uuid())
  name      String   @unique
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members GroupMember[]
  grants  AccessGroupGrant[]

  @@map("AccessGroup")
}

model GroupMember {
  id        String @id @default(uuid())
  userId    String
  groupId   String
  role      GroupRole @default(MEMBER)
  createdAt DateTime  @default(now())

  user  User        @relation(fields: [userId], references: [id])
  group AccessGroup @relation(fields: [groupId], references: [id])

  @@unique([userId, groupId])
  @@map("GroupMember")
}

model AccessGroupGrant {
  id        String   @id @default(uuid())
  groupId   String
  moduleId  String
  actions   Action[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group  AccessGroup @relation(fields: [groupId], references: [id])
  module Module      @relation(fields: [moduleId], references: [id])

  @@unique([groupId, moduleId])
  @@map("AccessGroupGrant")
}
