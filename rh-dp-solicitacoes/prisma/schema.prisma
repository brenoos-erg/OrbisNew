generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ===================== Enums =====================
 */

enum Role {
  COLABORADOR
  RH
  DP
  ADMIN
}

enum Setor {
  RH
  DP
}

enum Status {
  ABERTA
  EM_ANALISE
  AGUARDANDO_INFO
  APROVADA
  REJEITADA
  CONCLUIDA
}

enum UserStatus {
  ATIVO
  INATIVO
}

/**
 * ===================== Models =====================
 */

model Attachment {
  id             String   @id
  solicitationId String
  filename       String
  url            String
  mimeType       String
  sizeBytes      Int
  createdAt      DateTime @default(now())

  solicitation Solicitation @relation(fields: [solicitationId], references: [id])
}

model Comment {
  id             String   @id
  solicitationId String
  autorId        String
  texto          String
  createdAt      DateTime @default(now())

  // lado que aponta para Solicitation
  solicitation Solicitation @relation(fields: [solicitationId], references: [id])

  // lado que aponta para User (autor do comentário)
  autor User @relation(name: "CommentAutor", fields: [autorId], references: [id])
}

model Event {
  id             String   @id
  solicitationId String
  actorId        String
  tipo           String
  createdAt      DateTime @default(now())

  // lado que aponta para Solicitation
  solicitation Solicitation @relation(fields: [solicitationId], references: [id])

  // lado que aponta para User (quem executou a ação)
  actor User @relation(name: "EventActor", fields: [actorId], references: [id])
}

model TipoSolicitacao {
  id         String   @id
  nome       String   @unique
  descricao  String?
  schemaJson Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  solicitacoes Solicitation[]
}

model Solicitation {
  id            String   @id
  titulo        String
  descricao     String
  setorDestino  Setor
  status        Status   @default(ABERTA)
  autorId       String
  responsavelId String?
  tipoId        String
  payload       Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // relações
  tipo TipoSolicitacao @relation(fields: [tipoId], references: [id])

  // autor / responsável
  autor       User  @relation(name: "SolicitationAutor", fields: [autorId], references: [id])
  responsavel User? @relation(name: "SolicitationResponsavel", fields: [responsavelId], references: [id])

  comentarios Comment[]
  anexos      Attachment[]
  eventos     Event[]
}

model User {
  id         String     @id @default(dbgenerated("(gen_random_uuid())::text"))
  email      String     @unique
  fullName   String // se sua coluna no banco ainda for "name", mapeie: @map("name")
  login      String?    @unique(map: "user_login_key")
  phone      String?
  costCenter String?
  status     UserStatus @default(ATIVO)
  authId     String?    @db.Uuid
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // lados opostos das relações (obrigatórios para evitar P1012)
  solicitacoesCriadas   Solicitation[] @relation("SolicitationAutor")
  solicitacoesAssumidas Solicitation[] @relation("SolicitationResponsavel")
  comments              Comment[]      @relation("CommentAutor")
  events                Event[]        @relation("EventActor")

  @@map("User") // mantém apontando para a tabela pública "User"
}
