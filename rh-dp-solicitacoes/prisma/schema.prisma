generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum Role {
  COLABORADOR
  RH
  DP
  ADMIN
}

enum Setor {
  RH
  DP
}

enum Status {
  ABERTA
  EM_ANALISE
  AGUARDANDO_INFO
  APROVADA
  REJEITADA
  CONCLUIDA
}

enum UserStatus {
  ATIVO
  INATIVO
}

enum CCStatus {
  ACTIVE
  INACTIVE
}

/**
 * ===== NOVOS ENUMS =====
 */

enum Action {
  VIEW
  CREATE
  UPDATE
  DELETE
  APPROVE
}

enum GroupRole {
  MEMBER
  MANAGER
}

/**
 * ===== ENUMS DE SOLICITAÇÃO =====
 */

enum ApprovalStatus {
  NAO_PRECISA
  PENDENTE
  APROVADO
  REPROVADO
}

enum SolicitationStatus {
  ABERTA
  EM_ATENDIMENTO
  AGUARDANDO_APROVACAO
  CONCLUIDA
  CANCELADA
}

enum SolicitationPriority {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

/**
 * =========================
 * MODELOS DE SUPORTE
 * =========================
 */

model Attachment {
  id             String   @id
  solicitationId String
  filename       String
  url            String
  mimeType       String
  sizeBytes      Int
  createdAt      DateTime @default(now())

  solicitation Solicitation @relation(fields: [solicitationId], references: [id])
}

model Comment {
  id             String   @id
  solicitationId String
  autorId        String
  texto          String
  createdAt      DateTime @default(now())

  autor        User         @relation("CommentAutor", fields: [autorId], references: [id])
  solicitation Solicitation @relation(fields: [solicitationId], references: [id])
}

model Event {
  id             String   @id
  solicitationId String
  actorId        String
  tipo           String
  createdAt      DateTime @default(now())

  actor        User         @relation("EventActor", fields: [actorId], references: [id])
  solicitation Solicitation @relation(fields: [solicitationId], references: [id])
}

/**
 * =========================
 * CATALOGOS / CADASTROS
 * =========================
 */

model CostCenter {
  id             String   @id @default(uuid())
  code           String?
  externalCode   String?
  abbreviation   String?
  area           String?
  managementType String?
  groupName      String?  @map("group_name")
  status         CCStatus @default(ACTIVE)
  description    String
  observations   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  users User[]

  // N:N via UserCostCenter
  userLinks UserCostCenter[]

  // relação com módulos (modelo antigo)
  modules CostCenterModule[]

  // relação com solicitações
  solicitations Solicitation[]

  // relação com departamento
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  @@map("CostCenter")
}

model Position {
  id          String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  name        String  @unique
  description String?

  // Campos para auto-preenchimento da RQ_063
  sectorProject           String? // Setor e/ou Projeto
  workplace               String? // Local de Trabalho
  workSchedule            String? // Horário de Trabalho
  mainActivities          String? // Principais atividades
  complementaryActivities String? // Atividades complementares
  schooling               String? // Escolaridade
  course                  String? // Curso
  schoolingCompleted      String? // 'Sim' | 'Não' | outro texto
  courseInProgress        String? // 'Sim' | 'Não' | outro texto
  periodModule            String? // Período / Módulo
  requiredKnowledge       String? // Requisitos e conhecimentos necessários
  behavioralCompetencies  String? // Competências comportamentais exigidas
  enxoval                 String? // info sobre enxoval
  uniform                 String? // info sobre uniforme
  others                  String? // Outros (descrever)
  workPoint               String? // Ponto de trabalho
  site                    String? // Local (Matriz, Filial, etc.)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId String?
  users        User[]

  @@map("Position")
}

model Leader {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  fullName  String
  email     String?  @unique
  phone     String?
  members   User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Leader")
}

/**
 * =========================
 * NÚCLEO DE SOLICITAÇÕES
 * =========================
 */

model TipoSolicitacao {
  id           String         @id
  nome         String         @unique
  descricao    String?
  schemaJson   Json
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  solicitacoes Solicitation[]
}

model Department {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  solicitations Solicitation[]

  // relação com centros de custo
  costCenters CostCenter[]

  // módulos habilitados para esse departamento
  modules DepartmentModule[]

  positions Position[] // <--- ADICIONE ESSA LINHA
}

model Solicitation {
  id        String @id @default(uuid())
  protocolo String @unique

  tipoId String
  tipo   TipoSolicitacao @relation(fields: [tipoId], references: [id])

  costCenterId String
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id])

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  solicitanteId String
  solicitante   User   @relation("SolicitationSolicitante", fields: [solicitanteId], references: [id])

  requiresApproval Boolean @default(false)
  approverId       String?
  approver         User?   @relation("SolicitationAprovador", fields: [approverId], references: [id])

  approvalStatus  ApprovalStatus @default(NAO_PRECISA)
  approvalAt      DateTime?
  approvalComment String?

  status     SolicitationStatus    @default(ABERTA)
  prioridade SolicitationPriority?

  /// Campo para controlar se a vaga já está prevista no orçamento
  vagaPrevista Boolean @default(false)

  titulo    String
  descricao String?

  payload Json

  dataAbertura     DateTime  @default(now())
  dataPrevista     DateTime?
  dataFechamento   DateTime?
  dataCancelamento DateTime?

  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  timelines SolicitationTimeline[]

  anexos      Attachment[]
  comentarios Comment[]
  eventos     Event[]

  /// VÍNCULO ENTRE CHAMADOS (pai/filhos)
  parentId String?
  parent   Solicitation?  @relation("SolicitationParent", fields: [parentId], references: [id])
  children Solicitation[] @relation("SolicitationParent")

  // em model Solicitation
  assumidaPorId String?
  assumidaEm    DateTime?
  assumidaPor   User?     @relation("SolicitationAssumidaPor", fields: [assumidaPorId], references: [id])
}

/**
 * =========================
 * USUÁRIO
 * =========================
 */

model User {
  id        String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  email     String  @unique
  fullName  String
  login     String? @unique(map: "user_login_key")
  phone     String?
  avatarUrl String?

  // CC principal
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  // N:N via UserCostCenter
  costCenters UserCostCenter[]

  // departamento
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  status    UserStatus @default(ATIVO)
  role      Role       @default(COLABORADOR)
  authId    String?    @unique @db.Uuid
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // relações com Solicitation
  solicitacoesCriadas   Solicitation[] @relation("SolicitationSolicitante")
  solicitacoesAprovador Solicitation[] @relation("SolicitationAprovador")
  solicitacoesAssumidas Solicitation[] @relation("SolicitationAssumidaPor")

  comments Comment[] @relation("CommentAutor")
  events   Event[]   @relation("EventActor")

  membersOfGroups GroupMember[]
  position        Position?     @relation(fields: [positionId], references: [id])
  positionId      String?
  leader          Leader?       @relation(fields: [leaderId], references: [id])
  leaderId        String?

  // relação com níveis de módulo
  moduleAccesses UserModuleAccess[]

  @@map("User")
}

/**
 * =========================
 * CONTROLE DE ACESSOS
 * =========================
 */

model Module {
  id        String   @id @default(uuid())
  key       String   @unique // 'SOLICITACOES' | 'CONFIGURACOES'
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações existentes
  grants      AccessGroupGrant[]
  costCenters CostCenterModule[]

  // Novas relações de controle de nível
  userAccess UserModuleAccess[]
  deptAccess DepartmentModule[]

  @@map("Module")
}

model AccessGroup {
  id        String   @id @default(uuid())
  name      String   @unique
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members GroupMember[]
  grants  AccessGroupGrant[]

  @@map("AccessGroup")
}

model GroupMember {
  id        String    @id @default(uuid())
  userId    String
  groupId   String
  role      GroupRole @default(MEMBER)
  createdAt DateTime  @default(now())

  user  User        @relation(fields: [userId], references: [id])
  group AccessGroup @relation(fields: [groupId], references: [id])

  @@unique([userId, groupId])
  @@map("GroupMember")
}

model AccessGroupGrant {
  id        String   @id @default(uuid())
  groupId   String
  moduleId  String
  actions   Action[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group  AccessGroup @relation(fields: [groupId], references: [id])
  module Module      @relation(fields: [moduleId], references: [id])

  @@unique([groupId, moduleId])
  @@map("AccessGroupGrant")
}

model CostCenterModule {
  id           String   @id @default(uuid())
  costCenterId String
  moduleId     String
  createdAt    DateTime @default(now())

  costCenter CostCenter @relation(fields: [costCenterId], references: [id])
  module     Module     @relation(fields: [moduleId], references: [id])

  @@unique([costCenterId, moduleId])
  @@map("CostCenterModule")
}

model UserCostCenter {
  id           String   @id @default(uuid())
  userId       String
  costCenterId String
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id])
  costCenter CostCenter @relation(fields: [costCenterId], references: [id])

  @@unique([userId, costCenterId])
  @@map("UserCostCenter")
}

model SolicitationTimeline {
  id             String   @id @default(uuid())
  solicitationId String
  status         String
  message        String?
  createdAt      DateTime @default(now())

  solicitation Solicitation @relation(fields: [solicitationId], references: [id])
}

/**
 * =========================
 * CONTROLE DE NÍVEL POR MÓDULO
 * =========================
 */

enum ModuleLevel {
  NIVEL_1
  NIVEL_2
  NIVEL_3
}

model UserModuleAccess {
  id       String      @id @default(uuid())
  userId   String
  moduleId String
  level    ModuleLevel

  user   User   @relation(fields: [userId], references: [id])
  module Module @relation(fields: [moduleId], references: [id])

  @@unique([userId, moduleId])
  @@map("UserModuleAccess")
}

model DepartmentModule {
  id           String @id @default(uuid())
  departmentId String
  moduleId     String

  department Department @relation(fields: [departmentId], references: [id])
  module     Module     @relation(fields: [moduleId], references: [id])

  @@unique([departmentId, moduleId])
  @@map("DepartmentModule")
}
