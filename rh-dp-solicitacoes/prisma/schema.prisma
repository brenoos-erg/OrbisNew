generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Attachment {
  id             String       @id
  solicitationId String
  filename       String
  url            String
  mimeType       String
  sizeBytes      Int
  createdAt      DateTime     @default(now())
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model RefusalAttachment {
  id        String        @id
  reportId  String
  filename  String
  url       String
  mimeType  String
  sizeBytes Int
  createdAt DateTime      @default(now())
  report    RefusalReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
}

model RefusalReport {
  id                     String              @id @default(dbgenerated("(gen_random_uuid())::text"))
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  employeeId             String
  employeeName           String
  sectorOrContract       String
  riskSituation          String
  locationOrEquipment    String
  detailedCondition      String
  contractManagerName    String?
  generalCoordinatorName String?
  contractManagerId      String?
  generalCoordinatorId   String?
  status                 RefusalStatus       @default(PENDENTE)
  decision               Boolean?
  decisionComment        String?
  decidedAt              DateTime?
  decidedById            String?
  decisionLevel          ModuleLevel?
  attachments            RefusalAttachment[]
  contractManager        User?               @relation("RefusalReportContractManager", fields: [contractManagerId], references: [id])
  decidedBy              User?               @relation("RefusalReportDecisionUser", fields: [decidedById], references: [id])
  employee               User                @relation("RefusalReportEmployee", fields: [employeeId], references: [id])
  generalCoordinator     User?               @relation("RefusalReportGeneralCoordinator", fields: [generalCoordinatorId], references: [id])
}

model Comment {
  id             String       @id
  solicitationId String
  autorId        String
  texto          String
  createdAt      DateTime     @default(now())
  autor          User         @relation("CommentAutor", fields: [autorId], references: [id])
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model Event {
  id             String       @id
  solicitationId String
  actorId        String
  tipo           String
  createdAt      DateTime     @default(now())
  actor          User         @relation("EventActor", fields: [actorId], references: [id])
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model CostCenter {
  id                   String                       @id @default(uuid())
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  abbreviation         String?
  area                 String?
  code                 String?
  description          String
  externalCode         String?                      @unique(map: "CostCenter_externalCode_uq")
  managementType       String?
  status               CCStatus                     @default(ACTIVE)
  groupName            String?                      @map("group_name")
  observations         String?
  departmentId         String?
  department           Department?                  @relation(fields: [departmentId], references: [id])
  modules              CostCenterModule[]
  solicitations        Solicitation[]
  users                User[]
  userLinks            UserCostCenter[]
  vehicleCostCenters   VehicleCostCenter[]
  displacementCheckins VehicleDisplacementCheckin[]
  tiEquipmentSnapshots TiEquipment[]

  @@map("CostCenter")
}

model Position {
  id                      String      @id @default(dbgenerated("(gen_random_uuid())::text"))
  name                    String      @unique
  description             String?
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt
  behavioralCompetencies  String?
  complementaryActivities String?
  course                  String?
  courseInProgress        String?
  departmentId            String?
  enxoval                 String?
  experience              String?
  mainActivities          String?
  others                  String?
  periodModule            String?
  requiredKnowledge       String?
  schooling               String?
  schoolingCompleted      String?
  sectorProject           String?
  site                    String?
  uniform                 String?
  workPoint               String?
  workSchedule            String?
  workplace               String?
  department              Department? @relation(fields: [departmentId], references: [id])
  users                   User[]

  @@map("Position")
}

model Leader {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  fullName  String
  email     String?  @unique
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  members   User[]

  @@map("Leader")
}

model TipoSolicitacao {
  id           String         @id
  nome         String         @unique
  descricao    String?
  schemaJson   Json
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  solicitacoes Solicitation[]
}

model Department {
  id              String             @id @default(uuid())
  name            String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  code            String             @unique
  costCenters     CostCenter[]
  modules         DepartmentModule[]
  positions       Position[]
  solicitations   Solicitation[]
  users           User[]
  userDepartments UserDepartment[]
}

model Solicitation {
  id               String                 @id @default(uuid())
  titulo           String
  descricao        String?
  tipoId           String
  payload          Json
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  approvalAt       DateTime?
  approvalComment  String?
  approvalStatus   ApprovalStatus         @default(NAO_PRECISA)
  approverId       String?
  costCenterId     String
  dataAbertura     DateTime               @default(now())
  dataCancelamento DateTime?
  dataFechamento   DateTime?
  dataPrevista     DateTime?
  departmentId     String
  prioridade       SolicitationPriority?
  protocolo        String                 @unique
  requiresApproval Boolean                @default(false)
  solicitanteId    String
  status           SolicitationStatus     @default(ABERTA)
  parentId         String?
  vagaPrevista     Boolean                @default(false)
  assumidaPorId    String?
  assumidaEm       DateTime?
  anexos           Attachment[]
  comentarios      Comment[]
  eventos          Event[]
  approver         User?                  @relation("SolicitationAprovador", fields: [approverId], references: [id], onUpdate: NoAction)
  assumidaPor      User?                  @relation("SolicitationAssumidaPor", fields: [assumidaPorId], references: [id], onUpdate: NoAction)
  costCenter       CostCenter             @relation(fields: [costCenterId], references: [id])
  department       Department             @relation(fields: [departmentId], references: [id])
  parent           Solicitation?          @relation("SolicitationParent", fields: [parentId], references: [id])
  children         Solicitation[]         @relation("SolicitationParent")
  solicitante      User                   @relation("SolicitationSolicitante", fields: [solicitanteId], references: [id])
  tipo             TipoSolicitacao        @relation(fields: [tipoId], references: [id])
  timelines        SolicitationTimeline[]
}

model User {
  id                                         String                       @id @default(dbgenerated("(gen_random_uuid())::text"))
  email                                      String                       @unique
  role                                       Role                         @default(COLABORADOR)
  createdAt                                  DateTime                     @default(now())
  updatedAt                                  DateTime                     @updatedAt
  authId                                     String?                      @unique @db.Uuid
  fullName                                   String
  login                                      String?                      @unique(map: "user_login_key")
  phone                                      String?
  status                                     UserStatus                   @default(ATIVO)
  leaderId                                   String?
  costCenterId                               String?
  positionId                                 String?
  avatarUrl                                  String?
  departmentId                               String?
  comments                                   Comment[]                    @relation("CommentAutor")
  events                                     Event[]                      @relation("EventActor")
  membersOfGroups                            GroupMember[]
  refusalReportsAsContractManager            RefusalReport[]              @relation("RefusalReportContractManager")
  refusalReportsAsDecidedBy                  RefusalReport[]              @relation("RefusalReportDecisionUser")
  refusalReportsAsEmployee                   RefusalReport[]              @relation("RefusalReportEmployee")
  refusalReportsAsGeneralCoordinator         RefusalReport[]              @relation("RefusalReportGeneralCoordinator")
  solicitacoesAprovador                      Solicitation[]               @relation("SolicitationAprovador")
  solicitacoesAssumidas                      Solicitation[]               @relation("SolicitationAssumidaPor")
  solicitacoesCriadas                        Solicitation[]               @relation("SolicitationSolicitante")
  costCenter                                 CostCenter?                  @relation(fields: [costCenterId], references: [id])
  department                                 Department?                  @relation(fields: [departmentId], references: [id])
  leader                                     Leader?                      @relation(fields: [leaderId], references: [id])
  position                                   Position?                    @relation(fields: [positionId], references: [id])
  costCenters                                UserCostCenter[]
  userDepartments                            UserDepartment[]
  moduleAccesses                             UserModuleAccess[]
  vehicleCheckins                            VehicleCheckin[]
  vehicleDisplacementCheckins                VehicleDisplacementCheckin[]
  vehicleStatusLogs                          VehicleStatusLog[]
  tiEquipments                               TiEquipment[]
  WorkRefusal_WorkRefusal_analyzedByIdToUser WorkRefusal[]                @relation("WorkRefusal_analyzedByIdToUser")
  WorkRefusal_WorkRefusal_createdByIdToUser  WorkRefusal[]                @relation("WorkRefusal_createdByIdToUser")
  WorkRefusalAttachment                      WorkRefusalAttachment[]
  WorkRefusalHistory                         WorkRefusalHistory[]

  @@map("User")
}

model Module {
  id          String             @id @default(uuid())
  key         String             @unique
  name        String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  grants      AccessGroupGrant[]
  costCenters CostCenterModule[]
  deptAccess  DepartmentModule[]
  userAccess  UserModuleAccess[]
  features    ModuleFeature[]

  @@map("Module")
}

model AccessGroup {
  id        String             @id @default(uuid())
  name      String             @unique
  notes     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  grants    AccessGroupGrant[]
   featureGrants FeatureGrant[]
  members   GroupMember[]

  @@map("AccessGroup")
}

model GroupMember {
  id        String      @id @default(uuid())
  userId    String
  groupId   String
  role      GroupRole   @default(MEMBER)
  createdAt DateTime    @default(now())
  group     AccessGroup @relation(fields: [groupId], references: [id])
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, groupId])
  @@map("GroupMember")
}

model AccessGroupGrant {
  id        String      @id @default(uuid())
  groupId   String
  moduleId  String
  actions   Action[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  group     AccessGroup @relation(fields: [groupId], references: [id])
  module    Module      @relation(fields: [moduleId], references: [id])

  @@unique([groupId, moduleId])
  @@map("AccessGroupGrant")
}
model ModuleFeature {
  id        String      @id @default(uuid())
  moduleId  String
  key       String
  name      String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  module    Module      @relation(fields: [moduleId], references: [id])
  grants    FeatureGrant[]
  levelGrants FeatureLevelGrant[]

  @@unique([moduleId, key])
  @@map("ModuleFeature")
}

model FeatureGrant {
  id        String      @id @default(uuid())
  groupId   String
  featureId String
  actions   Action[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  group     AccessGroup @relation(fields: [groupId], references: [id])
  feature   ModuleFeature @relation(fields: [featureId], references: [id])

  @@unique([groupId, featureId])
  @@map("FeatureGrant")
}
model FeatureLevelGrant {
  id        String       @id @default(uuid())
  featureId String
  level     ModuleLevel
  actions   Action[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  feature   ModuleFeature @relation(fields: [featureId], references: [id])

  @@unique([featureId, level])
  @@map("FeatureLevelGrant")
}
model CostCenterModule {
  id           String     @id @default(uuid())
  costCenterId String
  moduleId     String
  createdAt    DateTime   @default(now())
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id])
  module       Module     @relation(fields: [moduleId], references: [id])

  @@unique([costCenterId, moduleId])
  @@map("CostCenterModule")
}

model UserCostCenter {
  id           String     @id @default(uuid())
  userId       String
  costCenterId String
  createdAt    DateTime   @default(now())
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id])
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, costCenterId])
  @@map("UserCostCenter")
}

model SolicitationTimeline {
  id             String       @id @default(uuid())
  solicitationId String
  status         String
  message        String?
  createdAt      DateTime     @default(now())
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model UserModuleAccess {
  id       String      @id @default(uuid())
  userId   String
  moduleId String
  level    ModuleLevel
  module   Module      @relation(fields: [moduleId], references: [id])
  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, moduleId])
  @@map("UserModuleAccess")
}

model DepartmentModule {
  id           String     @id @default(uuid())
  departmentId String
  moduleId     String
  department   Department @relation(fields: [departmentId], references: [id])
  module       Module     @relation(fields: [moduleId], references: [id])

  @@unique([departmentId, moduleId])
  @@map("DepartmentModule")
}

model UserDepartment {
  id           String     @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId       String
  departmentId String
  createdAt    DateTime   @default(now())
  department   Department @relation(fields: [departmentId], references: [id])
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, departmentId])
  @@map("UserDepartment")
}
enum TiEquipmentCategory {
  LINHA_TELEFONICA
  SMARTPHONE
  NOTEBOOK
  DESKTOP
  MONITOR
  IMPRESSORA
  TPLINK
  OUTROS
}

enum TiEquipmentStatus {
  IN_STOCK
  ASSIGNED
  MAINTENANCE
  RETIRED
}

model TiEquipment {
  id                    String              @id @default(uuid())
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  name                  String
  patrimonio            String              @unique
  userId                String
  value                 Decimal?           @db.Decimal(14, 2)
  costCenterIdSnapshot  String?
  serialNumber          String?             @unique
  category              TiEquipmentCategory
  status                TiEquipmentStatus   @default(IN_STOCK)
  observations          String?
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  costCenterSnapshot    CostCenter?         @relation(fields: [costCenterIdSnapshot], references: [id], onDelete: SetNull)

  @@index([category, status])
  @@map("TiEquipment")
}

model Vehicle {
  id                   String                       @id @default(cuid())
  plate                String                       @unique
  type                 String
  model                String?
  costCenter           String?
  sector               String?
  kmCurrent            Int                          @default(0)
  status               String                       @default("DISPONIVEL")
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt
  checkins             VehicleCheckin[]
  costCenters          VehicleCostCenter[]
  displacementCheckins VehicleDisplacementCheckin[]
  statusLogs           VehicleStatusLog[]
}

model VehicleCostCenter {
  id           String     @id @default(uuid())
  vehicleId    String
  costCenterId String
  createdAt    DateTime   @default(now())
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id])
  vehicle      Vehicle    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, costCenterId])
  @@map("VehicleCostCenter")
}

model VehicleCheckin {
  id                       String    @id @default(cuid())
  vehicleId                String
  driverId                 String
  inspectionDate           DateTime
  costCenter               String?
  sectorActivity           String?
  driverName               String
  vehiclePlateSnapshot     String
  vehicleTypeSnapshot      String
  kmAtInspection           Int
  checklistJson            Json
  fatigueJson              Json
  fatigueScore             Int
  fatigueRisk              String
  driverStatus             String
  hasNonConformity         Boolean
  nonConformityCriticality String?
  nonConformityActions     String?
  nonConformityManager     String?
  nonConformityDate        DateTime?
  createdAt                DateTime  @default(now())
  vehicleStatus            String    @default("DISPONIVEL")
  driver                   User      @relation(fields: [driverId], references: [id])
  vehicle                  Vehicle   @relation(fields: [vehicleId], references: [id])
}

model VehicleStatusLog {
  id          String   @id @default(cuid())
  vehicleId   String
  status      String
  reason      String
  createdById String?
  createdAt   DateTime @default(now())
  createdBy   User?    @relation(fields: [createdById], references: [id], onUpdate: NoAction)
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model VehicleDisplacementCheckin {
  id                   String      @id @default(cuid())
  vehicleId            String
  driverId             String
  tripDate             DateTime
  costCenterId         String?
  origin               String
  destination          String
  vehiclePlateSnapshot String
  vehicleTypeSnapshot  String
  vehicleModelSnapshot String?
  createdAt            DateTime    @default(now())
  vehicleKmSnapshot    Int?
  costCenter           CostCenter? @relation(fields: [costCenterId], references: [id])
  driver               User        @relation(fields: [driverId], references: [id])
  vehicle              Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model WorkRefusal {
  id                                  String                  @id
  gestorContrato                      String
  coordenadorGeral                    String
  nomeEmpregado                       String
  matricula                           String?
  setorContrato                       String
  situacaoRisco                       String
  localOuEquipamento                  String
  descricaoDetalhadaRisco             String
  status                              WorkRefusalStatus       @default(AGUARDANDO_PARECER)
  procede                             Boolean?
  parecerRecomendacoes                String?
  createdAt                           DateTime                @default(now())
  updatedAt                           DateTime                @default(now())
  analyzedAt                          DateTime?
  createdById                         String
  analyzedById                        String?
  deletedAt                           DateTime?
  User_WorkRefusal_analyzedByIdToUser User?                   @relation("WorkRefusal_analyzedByIdToUser", fields: [analyzedById], references: [id])
  User_WorkRefusal_createdByIdToUser  User                    @relation("WorkRefusal_createdByIdToUser", fields: [createdById], references: [id])
  WorkRefusalAttachment               WorkRefusalAttachment[]
  WorkRefusalHistory                  WorkRefusalHistory[]
}

model WorkRefusalAttachment {
  id            String      @id
  workRefusalId String
  filename      String
  url           String
  mimeType      String
  sizeBytes     Int
  createdAt     DateTime    @default(now())
  createdById   String?
  User          User?       @relation(fields: [createdById], references: [id])
  WorkRefusal   WorkRefusal @relation(fields: [workRefusalId], references: [id])
}

model WorkRefusalHistory {
  id            String            @id
  workRefusalId String
  status        WorkRefusalStatus
  message       String?
  createdAt     DateTime          @default(now())
  createdById   String?
  User          User?             @relation(fields: [createdById], references: [id])
  WorkRefusal   WorkRefusal       @relation(fields: [workRefusalId], references: [id])
}

enum Role {
  COLABORADOR
  RH
  DP
  ADMIN
}

enum Setor {
  RH
  DP
}

enum Status {
  ABERTA
  EM_ANALISE
  AGUARDANDO_INFO
  APROVADA
  REJEITADA
  CONCLUIDA
}

enum UserStatus {
  ATIVO
  INATIVO
}

enum CCStatus {
  ACTIVE
  INACTIVE
}

enum Action {
  VIEW
  CREATE
  UPDATE
  DELETE
  APPROVE
}

enum GroupRole {
  MEMBER
  MANAGER
}

enum ApprovalStatus {
  NAO_PRECISA
  PENDENTE
  APROVADO
  REPROVADO
}

enum SolicitationStatus {
  ABERTA
  EM_ATENDIMENTO
  AGUARDANDO_APROVACAO
  CONCLUIDA
  CANCELADA
}

enum SolicitationPriority {
  BAIXA
  MEDIA
  ALTA
  URGENTE
}

enum ModuleLevel {
  NIVEL_1
  NIVEL_2
  NIVEL_3
}

enum RefusalStatus {
  PENDENTE
  APROVADA
  REJEITADA
}

enum WorkRefusalStatus {
  EM_PREENCHIMENTO
  AGUARDANDO_PARECER
  PROCEDENTE
  NAO_PROCEDENTE
  ENCERRADO
}
