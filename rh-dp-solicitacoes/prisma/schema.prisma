generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   ENUMS
   ========================= */

enum Role {
  COLABORADOR
  RH
  DP
  ADMIN
}

enum Setor {
  RH
  DP
}

enum Status {
  ABERTA
  EM_ANALISE
  AGUARDANDO_INFO
  APROVADA
  REJEITADA
  CONCLUIDA
}

enum UserStatus {
  ATIVO
  INATIVO
}

enum CCStatus {
  ATIVADO
  INATIVO
}

/* =========================
   MODELOS DE SUPORTE
   ========================= */

model Attachment {
  id             String       @id
  solicitationId String
  filename       String
  url            String
  mimeType       String
  sizeBytes      Int
  createdAt      DateTime     @default(now())

  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model Comment {
  id             String       @id
  solicitationId String
  autorId        String
  texto          String
  createdAt      DateTime     @default(now())

  autor          User         @relation("CommentAutor", fields: [autorId], references: [id])
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

model Event {
  id             String       @id
  solicitationId String
  actorId        String
  tipo           String
  createdAt      DateTime     @default(now())

  actor          User         @relation("EventActor", fields: [actorId], references: [id])
  solicitation   Solicitation @relation(fields: [solicitationId], references: [id])
}

/* =========================
   CATALOGOS / CADASTROS
   ========================= */

/// Centro de Custo (completo – como no ERP)
model CostCenter {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  description    String   // <- temporariamente opcional
  code           String?   @unique
  externalCode   String?
  abbreviation   String?
  area           String?
  managementType String?
  groupName      String?
  status         CCStatus @default(ATIVADO)
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]

  @@map("CostCenter")
}


/// Cargo / Posição
model Position {
  id          String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  name        String  @unique
  description String?

  users   User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Position")
}

/// Líder (pessoa física cadastrada como líder)
model Leader {
  id        String @id @default(dbgenerated("(gen_random_uuid())::text"))
  fullName  String
  email     String? @unique
  phone     String?

  members  User[]   @relation("UserLeader")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Leader")
}

/* =========================
   NÚCLEO DE SOLICITAÇÕES
   ========================= */

model TipoSolicitacao {
  id           String         @id
  nome         String         @unique
  descricao    String?
  schemaJson   Json
  createdAt    DateTime       @default(now())
  updatedAt    DateTime

  solicitacoes Solicitation[]
}

model Solicitation {
  id            String          @id
  titulo        String
  descricao     String
  setorDestino  Setor
  status        Status          @default(ABERTA)
  autorId       String
  responsavelId String?
  tipoId        String
  payload       Json
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  anexos        Attachment[]
  comentarios   Comment[]
  eventos       Event[]

  autor         User            @relation("SolicitationAutor", fields: [autorId], references: [id])
  responsavel   User?           @relation("SolicitationResponsavel", fields: [responsavelId], references: [id])
  tipo          TipoSolicitacao @relation(fields: [tipoId], references: [id])
}

/* =========================
   USUÁRIO
   ========================= */

model User {
  id         String     @id @default(dbgenerated("(gen_random_uuid())::text"))
  email      String     @unique
  fullName   String
  login      String?    @unique(map: "user_login_key")
  phone      String?
  status     UserStatus @default(ATIVO)
  role       Role       @default(COLABORADOR)

  /// authId do Supabase (UUID) – opcional
  authId     String?    @db.Uuid

  // Relacionamentos opcionais com os cadastros
  costCenterId String?
  positionId   String?
  leaderId     String?

  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])
  position     Position?   @relation(fields: [positionId], references: [id])
  leader       Leader?     @relation("UserLeader", fields: [leaderId], references: [id])

  // audit
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // relações existentes
  solicitacoesCriadas   Solicitation[] @relation("SolicitationAutor")
  solicitacoesAssumidas Solicitation[] @relation("SolicitationResponsavel")
  comments              Comment[]      @relation("CommentAutor")
  events                Event[]        @relation("EventActor")

  @@map("User")
}
